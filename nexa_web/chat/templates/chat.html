<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Nexa –ß–∞—Ç</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { color: #333; text-align: center; }
    #messages { height: 400px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f9f9f9; border-radius: 5px; }
    .msg { margin: 5px 0; padding: 5px; border-left: 3px solid #007bff; }
    .self { color: #007bff; }
    .other { color: #28a745; }
    .time { font-size: 0.8em; color: #6c757d; }
    input, button { padding: 10px; margin: 5px; width: 70%; border: 1px solid #ddd; border-radius: 5px; }
    button { width: 25%; background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí¨ Nexa –ß–∞—Ç</h1>
    <p><strong>–í–∞—à ID:</strong> <code>{{ client_id }}</code></p>

    <div id="messages"></div>

    <input type="text" id="toId" placeholder="–ö–æ–º—É (ID)" />
    <input type="text" id="messageText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendMessage()" />
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <script>
    const clientId = "{{ client_id }}";
    const wsUrl = "{{ go_ws_url }}?id=" + encodeURIComponent(clientId);
    const ws = new WebSocket(wsUrl);

    const messagesDiv = document.getElementById("messages");

    function addMessage(text, sender, isSelf = false) {
      const div = document.createElement("div");
      div.className = "msg " + (isSelf ? "self" : "other");
      div.innerHTML = `<span class="sender"><strong>${sender}:</strong></span> ${text} <span class="time">${new Date().toLocaleTimeString()}</span>`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    ws.onopen = () => addMessage("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É", "–°–∏—Å—Ç–µ–º–∞");
    ws.onclose = () => addMessage("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ", "–°–∏—Å—Ç–µ–º–∞");
    ws.onerror = (err) => addMessage("–û—à–∏–±–∫–∞: " + err.message, "–°–∏—Å—Ç–µ–º–∞", false);

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

        if (!data.from || !data.data) {
          console.warn("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:", data);
          return;
        }

        let text;
        const dataType = typeof data.data;

        // === –°–ª—É—á–∞–π 1: data ‚Äî —Å—Ç—Ä–æ–∫–∞ (base64)
        if (dataType === 'string') {
          try {
            const binaryString = atob(data.data);  // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            text = new TextDecoder("utf-8").decode(bytes);
          } catch (e) {
            console.error("Base64 decode error:", e);
            text = "(–æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å)";
          }
        }

        // === –°–ª—É—á–∞–π 2: data ‚Äî –º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª [104,101,...]
        else if (Array.isArray(data.data)) {
          try {
            text = new TextDecoder("utf-8").decode(new Uint8Array(data.data));
          } catch (e) {
            text = "(–æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –±–∞–π—Ç—ã)";
          }
        }

        // === –°–ª—É—á–∞–π 3: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        else {
          text = "(–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö)";
        }

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    addMessage(text, data.from, data.from === clientId);

  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e, event.data);
    addMessage("‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", "–°–∏—Å—Ç–µ–º–∞");
  }
};

    function sendMessage() {
      const toId = document.getElementById("toId").value.trim();
      const text = document.getElementById("messageText").value.trim();
      if (!toId || !text) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ '–ö–æ–º—É' –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ");

      const encoder = new TextEncoder();
      const payload = {
        to: toId,
        from: clientId,
        data: Array.from(encoder.encode(`[${new Date().toLocaleTimeString()}] ${text}`))
      };

      // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
      ws.send(JSON.stringify(payload));

      // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –°–í–û–Å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç (–ª–æ–∫–∞–ª—å–Ω—ã–π echo)
      addMessage(text, "–í—ã", true);  // "–í—ã" –∏–ª–∏ `clientId`

      document.getElementById("messageText").value = "";
    }
  </script>
</body>
</html>